<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå UniversalFile Working Demo</title>
    <style>
        body { 
            background: linear-gradient(135deg, #000 0%, #111 100%); 
            color: #0f0; 
            font-family: 'Courier New', monospace; 
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #00f; }
        .warning { color: #ff0; }
        .panel {
            background: rgba(0,0,0,0.8);
            border: 2px solid #0f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
        }
        .code {
            background: #111;
            padding: 15px;
            border-left: 4px solid #0f0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .btn {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            cursor: pointer;
            font-family: inherit;
            margin: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 10px #0f0;
        }
        .spatial-view {
            height: 400px;
            border: 2px solid #0f0;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at center, #001100 0%, #000 100%);
            margin: 20px 0;
        }
        .item-node {
            position: absolute;
            background: rgba(0,0,0,0.8);
            border: 1px solid #0f0;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: move;
            transition: all 0.3s;
        }
        .item-node:hover {
            border-color: #ff0;
            box-shadow: 0 0 10px #ff0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-box {
            background: rgba(0,0,0,0.9);
            border: 1px solid #0f0;
            padding: 15px;
            text-align: center;
            border-radius: 4px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåå UniversalFile Working Demo</h1>
        
        <div class="panel">
            <h2>üìã System Status</h2>
            <div id="status">Loading...</div>
        </div>
        
        <div class="panel">
            <h2>üéÆ Interactive Demo</h2>
            <div>
                <button class="btn" onclick="createDocument()">üìÑ Create Document</button>
                <button class="btn" onclick="addRandomItem()">‚ûï Add Item</button>
                <button class="btn" onclick="testSerialization()">üíæ Test Binary</button>
                <button class="btn" onclick="runPerformanceTest()">‚ö° Performance</button>
                <button class="btn" onclick="showDocumentText()">üìù Show Text</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>üó∫Ô∏è Spatial View</h2>
            <div class="spatial-view" id="spatialView">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;">
                    Create a document to see spatial items
                </div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div>Items</div>
                <div class="stat-value" id="itemCount">0</div>
            </div>
            <div class="stat-box">
                <div>Binary Size</div>
                <div class="stat-value" id="binarySize">0 KB</div>
            </div>
            <div class="stat-box">
                <div>Version</div>
                <div class="stat-value" id="version">-</div>
            </div>
            <div class="stat-box">
                <div>Performance</div>
                <div class="stat-value" id="performance">Ready</div>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìä Results</h2>
            <div class="code" id="output">Ready to test UniversalFile format...</div>
        </div>
    </div>
    
    <script>
        // Inline UniversalDocument class for maximum compatibility
        // This avoids ES module issues and works in all browsers
        
        let currentDoc = null;
        let itemCounter = 0;
        
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += message + '\n';
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<span class="${type}">${message}</span>`;
        }
        
        function updateStats() {
            if (!currentDoc) return;
            
            document.getElementById('itemCount').textContent = currentDoc.allItems.length;
            document.getElementById('version').textContent = currentDoc.metadata.format_version;
            
            try {
                const binary = currentDoc.toBinary();
                document.getElementById('binarySize').textContent = (binary.byteLength / 1024).toFixed(2) + ' KB';
            } catch(e) {
                document.getElementById('binarySize').textContent = 'Error';
            }
        }
        
        function renderSpatialView() {
            if (!currentDoc) return;
            
            const view = document.getElementById('spatialView');
            view.innerHTML = '';
            
            currentDoc.allItems.forEach(item => {
                const node = document.createElement('div');
                node.className = 'item-node';
                node.style.left = (item.position.x * 0.3) + 'px';
                node.style.top = (item.position.y * 0.3) + 'px';
                node.innerHTML = `
                    <div style="font-weight: bold;">${item.title}</div>
                    <div style="font-size: 10px; opacity: 0.7;">
                        ${item.position.x},${item.position.y},${item.position.z}
                    </div>
                `;
                view.appendChild(node);
            });
        }
        
        // Try to load the ES module, fallback to manual implementation
        async function initializeUniversalDocument() {
            updateStatus('Attempting to load UniversalDocument...', 'info');
            
            try {
                // Try ES module import first
                const module = await import('./universalDocument.js');
                window.UniversalDocument = module.UniversalDocument;
                updateStatus('‚úÖ ES Module loaded successfully!', 'success');
                log('‚úÖ UniversalDocument loaded from ES module');
                
                // Test basic functionality
                const testDoc = new UniversalDocument();
                log('‚úÖ Test document created: ' + testDoc.metadata.format_version);
                
                return true;
                
            } catch (error) {
                updateStatus('‚ö†Ô∏è ES Module failed, using fallback implementation', 'warning');
                log('‚ö†Ô∏è ES Module error: ' + error.message);
                
                // Fallback: Create a minimal UniversalDocument implementation
                createFallbackImplementation();
                return false;
            }
        }
        
        function createFallbackImplementation() {
            // Minimal UniversalDocument implementation for demo purposes
            window.UniversalDocument = class UniversalDocument {
                constructor() {
                    this.metadata = {
                        format_version: "2.7.0-kira-fallback",
                        creator: "UniversalDesktop Fallback",
                        created_at: new Date().toISOString(),
                        canvas_bounds: { x: -16000, y: -16000, width: 32000, height: 32000 },
                        item_count: 0
                    };
                    this.items = new Map();
                    this.idCounter = 0;
                }
                
                get allItems() {
                    return Array.from(this.items.values());
                }
                
                createItem(options, origin) {
                    const id = `ud_item_${Date.now()}_${++this.idCounter}`;
                    const now = Date.now();
                    
                    const item = {
                        id,
                        ...options,
                        created_at: now,
                        updated_at: now,
                        origin: origin,
                        transformation_history: [{
                            id: `ud_trans_${now}`,
                            timestamp: now,
                            verb: 'created',
                            agent: origin.tool,
                            description: 'Item created with fallback implementation'
                        }]
                    };
                    
                    this.items.set(id, item);
                    this.metadata.item_count = this.items.size;
                    return item;
                }
                
                toBinary() {
                    // Simple binary serialization
                    const data = JSON.stringify({
                        metadata: this.metadata,
                        items: Array.from(this.items.values())
                    });
                    return new TextEncoder().encode(data);
                }
                
                static fromBinary(buffer) {
                    const data = JSON.parse(new TextDecoder().decode(buffer));
                    const doc = new UniversalDocument();
                    doc.metadata = data.metadata;
                    doc.items.clear();
                    data.items.forEach(item => doc.items.set(item.id, item));
                    return doc;
                }
            };
            
            // Add static properties
            UniversalDocument.ItemType = {
                NOTIZZETTEL: 0,
                TABELLE: 1,
                CODE: 2,
                TUI: 3,
                BROWSER: 4,
                MEDIA: 5,
                CHART: 6,
                CALENDAR: 7,
                AI_GENERATED: 8,
                DATABASE: 9,
                SYSTEM: 10
            };
            
            log('‚úÖ Fallback UniversalDocument implementation created');
        }
        
        // Demo functions
        function createDocument() {
            currentDoc = new UniversalDocument();
            log('‚úÖ New document created');
            log('Version: ' + currentDoc.metadata.format_version);
            log('Creator: ' + currentDoc.metadata.creator);
            updateStats();
            renderSpatialView();
        }
        
        function addRandomItem() {
            if (!currentDoc) {
                createDocument();
            }
            
            const itemTypes = ['üí≠ Thought', 'üìù Note', 'üéØ Goal', 'üåü Idea', 'üîÆ Vision'];
            const randomType = itemTypes[Math.floor(Math.random() * itemTypes.length)];
            
            const item = currentDoc.createItem({
                type: UniversalDocument.ItemType.NOTIZZETTEL,
                title: randomType + ' ' + (++itemCounter),
                position: { 
                    x: Math.random() * 800 + 100, 
                    y: Math.random() * 300 + 50, 
                    z: Math.floor(Math.random() * 3) 
                },
                dimensions: { width: 200, height: 100 },
                content: `This is a random ${randomType.split(' ')[1]} created for testing.`,
                is_contextual: Math.random() > 0.5
            }, {
                host: "demo.local",
                path: "/test/items",
                tool: "DemoCreator"
            });
            
            log(`‚úÖ Added item: ${item.title} at (${item.position.x}, ${item.position.y}, ${item.position.z})`);
            updateStats();
            renderSpatialView();
        }
        
        function testSerialization() {
            if (!currentDoc) {
                log('‚ùå No document to serialize');
                return;
            }
            
            const startTime = performance.now();
            const binary = currentDoc.toBinary();
            const serializeTime = performance.now() - startTime;
            
            const deserializeStart = performance.now();
            const restored = UniversalDocument.fromBinary(binary);
            const deserializeTime = performance.now() - deserializeStart;
            
            log(`‚úÖ Serialization test completed:`);
            log(`   Binary size: ${binary.byteLength} bytes`);
            log(`   Serialize time: ${serializeTime.toFixed(2)}ms`);
            log(`   Deserialize time: ${deserializeTime.toFixed(2)}ms`);
            log(`   Items preserved: ${restored.allItems.length}`);
            
            updateStats();
        }
        
        function runPerformanceTest() {
            log('üöÄ Running performance test...');
            
            const testDoc = new UniversalDocument();
            const startTime = performance.now();
            
            // Create 100 items
            for (let i = 0; i < 100; i++) {
                testDoc.createItem({
                    type: UniversalDocument.ItemType.NOTIZZETTEL,
                    title: `Perf Test Item ${i}`,
                    position: { x: Math.random() * 1000, y: Math.random() * 1000, z: 0 },
                    dimensions: { width: 100, height: 50 },
                    content: `Performance test content ${i}`,
                    is_contextual: false
                }, {
                    host: "perf.test",
                    path: "/benchmark",
                    tool: "PerfTester"
                });
            }
            
            const createTime = performance.now() - startTime;
            
            // Test serialization
            const serStart = performance.now();
            const binary = testDoc.toBinary();
            const serTime = performance.now() - serStart;
            
            const rate = (100 / createTime * 1000).toFixed(0);
            
            log(`‚úÖ Performance test results:`);
            log(`   Created 100 items in ${createTime.toFixed(2)}ms`);
            log(`   Rate: ${rate} items/second`);
            log(`   Binary size: ${(binary.byteLength / 1024).toFixed(2)} KB`);
            log(`   Serialization: ${serTime.toFixed(2)}ms`);
            
            document.getElementById('performance').textContent = rate + ' items/s';
        }
        
        function showDocumentText() {
            if (!currentDoc) {
                log('‚ùå No document to show');
                return;
            }
            
            log('üìÑ Document structure:');
            log('========================');
            log(`Format: ${currentDoc.metadata.format_version}`);
            log(`Items: ${currentDoc.allItems.length}`);
            log(`Created: ${currentDoc.metadata.created_at}`);
            log('');
            
            currentDoc.allItems.forEach(item => {
                log(`Item: ${item.title}`);
                log(`  Position: (${item.position.x}, ${item.position.y}, ${item.position.z})`);
                log(`  Content: ${item.content}`);
                log(`  Origin: ${item.origin.tool}`);
                log('');
            });
        }
        
        // Initialize when page loads
        window.addEventListener('load', async () => {
            await initializeUniversalDocument();
            updateStatus('üåå UniversalFile Demo Ready! Click buttons to test.', 'success');
            
            // Create a sample document
            setTimeout(() => {
                createDocument();
                addRandomItem();
                addRandomItem();
                log('‚úÖ Demo initialized with sample data');
            }, 1000);
        });
    </script>
</body>
</html>